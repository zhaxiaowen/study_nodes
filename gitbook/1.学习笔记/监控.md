# 监控

### 1.监控概述

从监控对象的角度来看，监控分为网络监控，存储监控，服务器监控和应用监控

从程序设计的角度来看，监控分为基础资源监控，中间件监控，应用监控和日志监控

![img](https://cdn.nlark.com/yuque/0/2021/png/21484941/1637131120658-767abc04-915f-4dce-9c37-093eebab2aad.png)

#### a.网络监控

- 实时流量监控
- 网络延迟

- 访问量
- 成功率

#### b.存储监控

- 存储性能监控：
  - 块存储：读写数量，IOPS,读写延迟，磁盘使用率
  - 文件存储：文件系统Inode，读写速率，目录权限等


#### c.服务器监控

- CPU:
  - CPU使用率
  - I/O等待百分比
  - 上下文切换次数
  - 缓存命中率
  - load average

- 内存：
  - 内存使用率
  - 缺页异常数

- 网络I/O：
  - 每个网卡的上行流量，下行流量，网络延迟，丢包率

- 磁盘I/O：
  - 读写速率
  - IOPS
  - 磁盘使用率
  - 读写延迟
  - IOwait


#### d.中间件监控

- 消息中间件：kafka集群
  - topic个数
  - broker数据分区数量
  - 日志offset值
  - 生产消费流量

- web服务中间件
- 缓存中间件：redis
  - 内存使用率
  - 连接数
  - 缓存命中率
  - key的个数
  - QPS

- 数据库中间件

#### e.应用程序监控（APM）

- 应用程序运行状态
- 性能
- 日志
- 调用链跟踪：
  - 追踪整个请求过程，从用户发送请求到后端API服务
  - API服务和关联的中间件或其他组件之间的调用
  - 组件内部方法的调用层次，获取每个函数的执行耗时


#### f.日志监控

- 数据统计
- 故障告警
- 性能问题定位
- 常用日志监控组件
  - Fluentd，Filebeat，Flume，Fluent Bit用于采集日志
  - Kafka：负责数据整流合并，避免突发日志流量直接冲击Logstash
  - Logstash：负责日志整理，完成日志过滤 ，日志修改等功能
  - Elasticsearch：负责日志存储和日志检索
  - Kibana：日志查询组件，负责日志展示


### 2.监控架构

#### a.监控实现方案：

- 数据采集：
  - 主动采集和被动上报

- 数据传输：
  - Socket传输和HTTP传输

- 数据存储：
  - Mysql和时序数据库


#### b.监控系统的核心：

- 数据采集系统：
  - 负责信息采集、过滤、汇总和存储
  - 通过客户端进行数据采集：针对特定的设备的采集器，和监控对象绑定部署，Prometheus的各种exporter就是这种
  - 通过标准协议进行数据采集：JMX协议，采集的数据规范统一

- 数据处理系统：
  - 数据分析、展示、预警、告警动作触发和告警




### 3.具体监控项

1. CPU:  https://www.zybuluo.com/Gugoole/note/1354842

   * Max值: 1减去1分钟内idle的平均值，就是cpu Max值

   * 平均负载：单位时间内，系统处于可运行状态和不可中断状态的平均进程数，也就是平均活跃进程数

     * 可运行状态：指正在使用CPU或正在等待CPU的进程

     * 不可中断状态：正处于内核态关键流程中的进程，比如等待硬件设备的I/O响应

     * 阈值：平均负载高于CPU数量的70%的时候，

     * 平均负载和CPU使用率的关系：平均负载包括正在使用CPU的进程、等待CPU和等待I/O的进程；CPU使用率是单位时间内CPU繁忙情况的统计，跟平均负载并不一定完全对应。CPU密集型进程，两者一致；I/O密集型，等待I/O也会导致平均负载高，但CPU使用率不一定高；大量等待CPU的进程调度也会导致平均负载升高，此时CPU使用率也会比较高。

   * 使用率：
     * idle：
     * system：
     * user：
     * Iowait：

   * CPU高，排查方向：

     * 用户CPU和Nice CPU高，说明用户态进程占用CPU,着重排查进程的性能问题

     * 系统CPU高，说明内核态占用CPU,着重排查内核线程或系统调用的性能问题
     * I/O等待CPU高，说明等待I/O时间较长，着重排查系统存储是不是出现了I/O问题
     * 软中断和硬中断高，着重排查内核中的中断服务程序

2. 内存：

   * 使用率：

   * 内存信息：
     * 总内存：
     * 已用：
     * 内存_Free：_
     * _内存_Buffers：
   * free -h:
     * total:总内存
     * used:已使用内存,包括共享内存
     * free:未使用内存
     * shared:共享内存
     * buff/cache:缓存/缓冲区内存
     * available:新进程可使用内存;包括了未使用内存和可回收的缓存
   * top
     * VIRT:进程虚拟内存大小,只要是进程申请过的内存,即便还没分配物理内存,也会计算在内
     * RES:常驻内存的大小,进程实际使用的物理内存大小,不包括swap和共享内存
     * SHR:共享内存的大小,于其他进程共同使用的共享内存、加载的动态链接库等
     * %MEM:进程使用物理内存占系统总内存的百分比
   * buff/cache
     * buffer:是对磁盘数据的缓存,既会用在读请求,也会用在写请求
     * cache:是文件数据的缓存,既会用在读请求,也会用在写请求
     * 在读写普通文件时,I/O请求会先经过文件系统,由文件系统于磁盘进行交互;读写块设备时,会跳过文件系统,直接与磁盘交互
     * 这两种读写使用的缓存不同,文件系统管理的缓存,就是cache的一部分;裸磁盘的缓存,用的就是buffer

3. 磁盘：

> 磁盘性能标准:使用率,饱和度,IOPS,吞吐量,响应时间
>
> 使用率:指磁盘处理I/O的时间百分比 
>
> 饱和度:磁盘处理I/O的繁忙程度,当饱和度100%时,磁盘无法接受新的I/O请求 %util
>
> IOPS:指每秒的I/O请求数;在随机读写比较多的场景中,IOPS能反应系统的整体性能 w/s  r/s  
>
> 吞吐量:指每秒的I/O请求大小;在顺序读写较多的场景,吞吐量能反应系统的整体性能 wkb/s rkb/s
>
> 响应时间:指I/O请求从发出到收到响应的间隔时间 await

* 分区使用率：

* 读写速率：

* IO读写时间：

* 磁盘容量：

* 每秒磁盘I/O操作耗时百分比：

4. 网络：

> 网络性能指标:带宽,吞吐量,延时,PPS
>
> 带宽:表示链路的最大传输速率,b/s;服务器选购网卡时,带宽就是最核心的参考指标,100m,10G,40G,100G等
>
> 吞吐量:表示没有丢包时的最大数据传输速率,b/s(比特/s),B/s(字节/s).吞吐量手带宽的限制,吞吐量/带宽就是该网络链路的使用率
>
> 延时:表示从网络请求发出后,一直到收到远端的响应,所需要的时间延迟
>
> PPS:表示以网络包为单位的传输速率.通常用来评估网络的转发能力

### 4. 系统监控项

![img](https://cdn.nlark.com/yuque/0/2021/png/21484941/1638410199807-cec8e977-1d9b-45c1-bda1-d88967075a3a.png)

### 5.应用监控项

1. 应用程序的核心指标:

   - 请求数

   - 错误率


   - 响应时间

2. 其他指标:

   - 应用进程的资源使用情况:进程占用CPU,内存,磁盘I/O,网络等

   - 应用程序之间调用情况:调用频率,错误数,延时等


   - 应用程序内部核心逻辑的运行情况


3. 全链路跟踪

4. 日志监控

### 6.k8s监控项

[k8s应该监控哪些指标及原因](https://cloud.tencent.com/developer/article/1861341)

[Kubernetes中部署ELK Stack日志收集平台](https://cloud.tencent.com/developer/article/1850626):列出了3种方案,并比较了之间的优劣,以及日志采集的注意事项

